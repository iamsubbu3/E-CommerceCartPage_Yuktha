pipeline {
    agent any

    tools {
        jdk 'jdk21'
    }

    options {
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        /* ---------- Build ---------- */
        DOCKER_BUILDKIT      = "1"

        /* ---------- SonarQube ---------- */
        SCANNER_HOME         = tool 'sonar-scanner'
        SONAR_HOST_URL       = 'http://sonarqube.company.com'
        SONAR_PROJECT_KEY    = 'Cart-app'

        /* ---------- Docker ---------- */
        DOCKER_USER_NAME     = 'iamsubbu3'
        DOCKER_IMAGE         = 'cart-app'
        REGISTRY_CRED        = 'docker-credentials'

        /* Semantic Versioning */
        MAJOR_VERSION        = "1"
        MINOR_VERSION        = "0"
        PATCH_VERSION        = "${BUILD_NUMBER}"

        DOCKER_TAG           = "v${MAJOR_VERSION}.${MINOR_VERSION}.${PATCH_VERSION}"
        FULL_IMAGE           = "${DOCKER_USER_NAME}/${DOCKER_IMAGE}:${DOCKER_TAG}"
        LATEST_IMAGE         = "${DOCKER_USER_NAME}/${DOCKER_IMAGE}:latest"

        /* ---------- AWS / EKS ---------- */
        EKS_CLUSTER_NAME     = 'subbu-cluster'
        AWS_REGION           = 'us-east-1'
        K8S_NAMESPACE        = 'subbu-1-ns'

        /* ---------- Notifications ---------- */
        NOTIFY_EMAILS        = 'subramanyam9979@gmail.com'
    }

    triggers {
        githubPush()
    }

    stages {

        /* ===================================================== */
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        /* ===================================================== */
        stage('Checkout Source Code') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/iamsubbu3/E-CommerceCartPage_Yuktha.git'
            }
        }

        /* ===================================================== */
        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonar') {
                    sh """
                        ${SCANNER_HOME}/bin/sonar-scanner \
                        -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                        -Dsonar.projectName=${SONAR_PROJECT_KEY} \
                        -Dsonar.sources=.
                    """
                }
            }
        }

        /* ===================================================== */
        stage('Sonar Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        /* ===================================================== */
        stage('Docker Build') {
            steps {
                script {
                    echo "üê≥ Building Docker image ${FULL_IMAGE}"
                    docker.build("${FULL_IMAGE}", "--pull .")
                }
            }
        }

        // /* ===================================================== */
        // stage('Trivy Security Scan') {
        //     steps {
        //         script {
        //             echo "üîç Running Trivy scan..."

        //             sh "trivy image --severity LOW,MEDIUM,HIGH ${FULL_IMAGE}"
        //             sh "trivy image --exit-code 1 --severity CRITICAL ${FULL_IMAGE}"
        //             sh "trivy image --format json -o trivy-report.json ${FULL_IMAGE}"

        //             archiveArtifacts artifacts: 'trivy-report.json', fingerprint: true
        //         }
        //     }
        // }

        /* ===================================================== */
        stage('Docker Push') {
            steps {
                script {
                    withDockerRegistry([credentialsId: REGISTRY_CRED, url: 'https://index.docker.io/v1/']) {

                        echo "üì¶ Pushing immutable tag: ${FULL_IMAGE}"
                        sh "docker push ${FULL_IMAGE}"

                        echo "üè∑Ô∏è Tagging as latest"
                        sh "docker tag ${FULL_IMAGE} ${LATEST_IMAGE}"
                        sh "docker push ${LATEST_IMAGE}"
                    }
                }
            }
        }

        /* ===================================================== */
        stage('Deploy to EKS') {
            steps {
                dir('k8s-manifests') {

                    withCredentials([
                        aws(
                            credentialsId: 'aws-keys',
                            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                        )
                    ]) {

                        sh """
                            aws eks update-kubeconfig \
                              --region ${AWS_REGION} \
                              --name ${EKS_CLUSTER_NAME}
                        """

                        /* Apply base resources */

                        sh "kubectl apply -f . -n ${K8S_NAMESPACE}"


                        /* Update deployment image safely */
                        sh """
                            kubectl set image deployment/cart-deployment \
                              cart-app=${FULL_IMAGE} \
                              -n ${K8S_NAMESPACE}
                        """

                        /* Verify rollout */
                        sh """
                            kubectl rollout status deployment/cart-deployment \
                              -n ${K8S_NAMESPACE}
                        """
                    }
                }
            }
        }
    }

    /* ===================================================== */
    post {

        success {
            emailext(
                subject: "‚úÖ SUCCESS | ${JOB_NAME} #${BUILD_NUMBER}",
                body: """
Hi Team,

‚úÖ Pipeline executed successfully.

üîπ Job Name : ${JOB_NAME}
üîπ Build No : ${BUILD_NUMBER}

üê≥ Immutable Image:
${FULL_IMAGE}

üè∑Ô∏è Latest Tag:
${LATEST_IMAGE}

üîó Jenkins Build:
${BUILD_URL}

üîó SonarQube:
${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}

Regards,
DevOps Automation
""",
                to: "${NOTIFY_EMAILS}"
            )
        }

        failure {
            emailext(
                subject: "‚ùå FAILURE | ${JOB_NAME} #${BUILD_NUMBER}",
                body: """
Hi Team,

‚ùå Pipeline FAILED.

üîπ Job Name : ${JOB_NAME}
üîπ Build No : ${BUILD_NUMBER}

üîó Logs:
${BUILD_URL}console

Regards,
DevOps Automation
""",
                to: "${NOTIFY_EMAILS}"
            )
        }

        always {
            echo "üßπ Cleaning Docker cache..."
            sh "docker image prune -f || true"
        }
    }
}
